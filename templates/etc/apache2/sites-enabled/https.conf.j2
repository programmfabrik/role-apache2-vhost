<VirtualHost *:80>
    ServerAdmin {{ apache2_vhost_server_admin }}

{% if apache2_vhost_rewrite_engine_enabled %}
    RewriteEngine on
    RewriteRule ^/(.*) {{ apache2_vhost_rewrite_rule_target }}
{% endif %}
{% if not apache2_vhost_rewrite_engine_enabled %}
    ProxyPass / {{ apache2_vhost_proxy_url }}
    ProxyPassReverse / {{ apache2_vhost_proxy_url }}
{% endif %}

</VirtualHost>

<VirtualHost *:443>
    ServerAdmin {{ apache2_vhost_server_admin }}

    SSLEngine on
    SSLCertificateFile  {{ apache2_vhost_ssl_certificate_file }}
    SSLCertificateKeyFile {{ apache2_vhost_ssl_certificate_key_file }}
{% if apache2_vhost_ssl_certificate_chain_file != '' %}
    SSLCertificateChainFile {{ apache2_vhost_ssl_certificate_chain_file }}
{% endif %}

{% if apache2_vhost_hotfolder_enabled %}
    AliasMatch ^/upload(.*)$ {{ apache2_vhost_hotfolder_fs_path }}$1
    <Location /upload>
        ProxyPass "!"
        Require all granted
        DAV on
        Options -MultiViews
        ErrorDocument 404 "Not Found"
        ErrorDocument 500 "Internal Server Error"
        ErrorDocument 502 "Bad Gateway"
    </Location>
{% endif %}

{% if apache2_vhost_shibboleth_enabled %}
    ProxyPass /Shibboleth.sso !
	ProxyPass /shibboleth !
	ProxyPass /shibboleth-sp !
	Alias /shibboleth-sp /usr/share/shibboleth

	<Location /api/v1/session/sso/authenticate>
		AuthType shibboleth
		ShibRequireSession on
		ShibRequestSetting requireSession 1
		ShibUseHeaders on
		Require valid-user
	</Location>

    ErrorDocument 401 /web/sso_authentication_required.html
{% endif %}
{% if apache2_vhost_kerberos_enabled %}
	RewriteEngine on
	RewriteRule .* - [E=X_REMOTE_USER:%{LA-F:REMOTE_USER}]
	RequestHeader set X-Remote-User "%{X_REMOTE_USER}e"

	<Location /api/v1/session/sso/authenticate>
		AuthType Kerberos
		AuthName "Kerberos login"
		KrbServiceName HTTP/{{ apache2_vhost_kerberos_service_name }}
		KrbAuthRealms {{ apache2_vhost_kerberos_auth_realms }}
		Krb5Keytab /etc/apache2/krb5.keytab
		KrbMethodNegotiate off
		KrbVerifyKDC off
		KrbMethodK5Passwd on
		Require valid-user
	</Location>

	ErrorDocument 401 /web/sso_authentication_required.html
{% endif %}

    ProxyPass / {{ apache2_vhost_proxy_url }}
    ProxyPassReverse / {{ apache2_vhost_proxy_url }}
</VirtualHost>
